<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TikTok Clone</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      overflow: hidden;
      background: #000;
      touch-action: pan-y; /* —É–ª—É—á—à–∞–µ—Ç —Å–∫—Ä–æ–ª–ª –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }
    #app {
      height: 100vh;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      -webkit-overflow-scrolling: touch;
    }
    .video-container {
      height: 100vh;
      width: 100vw;
      position: relative;
      scroll-snap-align: start;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }
    .overlay {
      position: absolute;
      bottom: 80px;
      left: 15px;
      color: white;
      z-index: 10;
      pointer-events: none;
    }
    .author {
      font-weight: 700;
      font-size: 17px;
      margin-bottom: 6px;
    }
    .description {
      font-size: 14px;
      line-height: 1.3;
      max-width: 85%;
    }
    .music {
      position: absolute;
      bottom: 30px;
      left: 15px;
      color: white;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sidebar {
      position: absolute;
      right: 10px;
      bottom: 90px;
      z-index: 20;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
    }
    .sidebar-item {
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    .sidebar-item img {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid white;
    }
    .sidebar-item .icon {
      font-size: 32px;
      margin-bottom: 4px;
    }
    .sidebar-item .count {
      font-size: 12px;
    }
    .like-animation {
      position: absolute;
      font-size: 80px;
      color: white;
      pointer-events: none;
      opacity: 0;
      z-index: 30;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    ::-webkit-scrollbar { display: none; }
    #app { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const app = document.getElementById('app');
    let currentVideo = null;

    // IntersectionObserver ‚Äî –∞–≤—Ç–æ–ø–ª–µ–π —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º–æ–≥–æ –≤–∏–¥–µ–æ
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const video = entry.target.querySelector('video');
        if (entry.isIntersecting && entry.intersectionRatio >= 0.6) {
          video.play();
          currentVideo = video;
        } else {
          video.pause();
        }
      });
    }, { threshold: [0, 0.6, 1] });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º videos.json
    fetch('videos.json')
      .then(res => res.json())
      .then(data => {
        data.videos.forEach(item => {
          const container = document.createElement('div');
          container.className = 'video-container';

          // –í–∏–¥–µ–æ
          const video = document.createElement('video');
          video.src = item.url;
          video.muted = true;
          video.loop = true;
          video.playsInline = true;
          video.preload = "metadata";
          container.appendChild(video);

          // –û–≤–µ—Ä–ª–µ–π (–∞–≤—Ç–æ—Ä + –æ–ø–∏—Å–∞–Ω–∏–µ)
          const overlay = document.createElement('div');
          overlay.className = 'overlay';
          overlay.innerHTML = `
            <div class="author">@${item.author || 'username'}</div>
            <div class="description">${item.description || ''}</div>
          `;
          container.appendChild(overlay);

          // –ú—É–∑—ã–∫–∞ –≤–Ω–∏–∑—É
          const music = document.createElement('div');
          music.className = 'music';
          music.innerHTML = `‚ô™ ${item.music || '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∑–≤—É–∫ ‚Äì ' + (item.author || 'username')}`;
          container.appendChild(music);

          // –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
          const sidebar = document.createElement('div');
          sidebar.className = 'sidebar';
          sidebar.innerHTML = `
            <div class="sidebar-item profile">
              <img src="${item.avatar || 'https://via.placeholder.com/48/333'}" alt="avatar">
              <div style="font-size:24px;margin-top:4px;">‚ûï</div>
            </div>
            <div class="sidebar-item like-btn">
              <div class="icon">‚ù§Ô∏è</div>
              <div class="count">${item.likes || '0'}</div>
            </div>
            <div class="sidebar-item">
              <div class="icon">üí¨</div>
              <div class="count">${item.comments || '0'}</div>
            </div>
            <div class="sidebar-item">
              <div class="icon">üîó</div>
              <div class="count">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</div>
            </div>
          `;
          container.appendChild(sidebar);

          // –ê–Ω–∏–º–∞—Ü–∏—è –ª–∞–π–∫–∞ –ø—Ä–∏ –¥–≤–æ–π–Ω–æ–º —Ç–∞–ø–µ
          const likeAnim = document.createElement('div');
          likeAnim.className = 'like-animation';
          likeAnim.innerHTML = '‚ù§Ô∏è';
          container.appendChild(likeAnim);

          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –∏ –¥–≤–æ–π–Ω–æ–≥–æ —Ç–∞–ø–∞
          let tapCount = 0;
          container.addEventListener('click', (e) => {
            if (e.target.closest('.sidebar')) return; // –Ω–µ –ø–∞—É–∑–∏–º –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –∏–∫–æ–Ω–∫–∞–º

            tapCount++;
            if (tapCount === 1) {
              setTimeout(() => {
                if (tapCount === 1) {
                  // –æ–¥–∏–Ω–æ—á–Ω—ã–π —Ç–∞–ø ‚Äî –ø–∞—É–∑–∞/–ø–ª–µ–π
                  video.paused ? video.play() : video.pause();
                }
                tapCount = 0;
              }, 300);
            } else if (tapCount === 2) {
              // –¥–≤–æ–π–Ω–æ–π —Ç–∞–ø ‚Äî –ª–∞–π–∫
              tapCount = 0;
              likeAnim.style.opacity = '1';
              likeAnim.style.transform = 'translate(-50%, -50%) scale(1.3)';
              setTimeout(() => {
                likeAnim.style.opacity = '0';
                likeAnim.style.transform = 'translate(-50%, -50%) scale(0)';
              }, 600);

              // —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª—å–Ω–æ)
              const countEl = container.querySelector('.like-btn .count');
              let count = parseInt(countEl.textContent.replace(/[^0-9]/g, '')) || 0;
              count++;
              countEl.textContent = count > 999 ? (count/1000).toFixed(1) + 'K' : count;
            }
          });

          app.appendChild(container);
          observer.observe(container);
        });

        // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –≤–∏–¥–µ–æ ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø–µ—Ä–≤–æ–≥–æ
        if (data.videos.length > 0) {
          setTimeout(() => app.scrollTop = 0, 100);
        }
      })
      .catch(err => {
        app.innerHTML = '<div style="color:white;text-align:center;padding-top:50vh;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ videos.json</div>';
        console.error(err);
      });
  </script>
</body>
</html>