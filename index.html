<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TikTok Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body, html { height: 100%; overflow:hidden; background:#000; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; }
    #app { height:100vh; overflow-y:scroll; scroll-snap-type:y mandatory; -webkit-overflow-scrolling:touch; scrollbar-width:none; }
    #app::-webkit-scrollbar { display:none; }

    .video-container {
      height:100vh; width:100vw; position:relative; scroll-snap-align:start; overflow:hidden;
      background:#000;
    }
    video {
      width:100%; height:100%; object-fit:cover;
    }

    /* Градиентный оверлей снизу */
    .bottom-overlay {
      position:absolute; left:0; right:0; bottom:0; height:280px;
      background:linear-gradient(180deg, transparent 0%, rgba(0,0,0,0.7) 100%);
      pointer-events:none; z-index:2;
    }

    /* Описание и автор */
    .info {
      position:absolute; left:16px; bottom:90px; z-index:10; color:white; max-width:80%;
      transform:translateY(30px); opacity:0; transition:all 0.6s ease;
    }
    .info.visible { transform:translateY(0); opacity:1; }
    .author { font-weight:700; font-size:18px; margin-bottom:6px; display:flex; align-items:center; gap:8px; }
    .description { font-size:15px; line-height:1.4; }

    /* Музыка с вращающимся диском */
    .music {
      position:absolute; left:16px; bottom:32px; color:white; font-size:14px; z-index:10;
      display:flex; align-items:center; gap:10px; transform:translateY(30px); opacity:0; transition:all 0.7s ease;
    }
    .music.visible { transform:translateY(0); opacity:1; }
    .music-disc {
      width:36px; height:36px; border-radius:50%; overflow:hidden; background:#111; display:flex; align-items:center; justify-content:center;
      animation: rotate 4s linear infinite;
    }
    .music-disc i { font-size:20px; color:#fe2c55; }

    }

    @keyframes rotate {
      from { transform:rotate(0deg); }
      to { transform:rotate(360deg); }
    }

    /* Боковая панель */
    .sidebar {
      position:absolute; right:12px; bottom:100px; z-index:20; color:white;
      display:flex; flex-direction:column; gap:20px; align-items:center;
    }
    .sidebar-item {
      text-align:center; cursor:pointer; transition:all 0.3s;
    }
    .avatar {
      width:48px; height:48px; border-radius:50%; border:2px solid white; object-fit:cover;
    }
    .plus {
      width:20px; height:20px; background:#fe2c55; color:white; border-radius:50%; margin-top:-12px;
      display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:bold;
    }
    .icon {
      font-size:36px; margin-bottom:6px;
    }
    .count {
      font-size:13px; font-weight:600;
    }
    .like-btn.liked .icon {
      animation: pulse 0.6s ease;
      color:#fe2c55;
    }
    @keyframes pulse {
      0% { transform:scale(1); }
      50% { transform:scale(1.4); }
      100% { transform:scale(1); }
    }

    /* Анимация лайка по двойному тапу */
    .like-animation {
      position:absolute; top:50%; left:50%; font-size:90px; color:#fe2c55;
      pointer-events:none; opacity:0; z-index:30;
      transform:translate(-50%, -50%) scale(0);
    }
    .like-animation.show {
      animation: likePop 0.8s ease forwards;
    }
    @keyframes likePop {
      0% { opacity:0; transform:translate(-50%, -50%) scale(0); }
      50% { opacity:1; transform:translate(-50%, -40%) scale(1.3); }
      100% { opacity:0; transform:translate(-50%, -100%) scale(1); }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    Telegram.WebApp.requestFullscreen();
    Telegram.WebApp.disableVerticalSwipes();

    const { createApp, ref, onMounted, nextTick } = Vue;

    createApp({
      setup() {
        const videos = ref([]);
        const currentIndex = ref(0);

        const loadVideos = async () => {
          try {
            const res = await fetch('videos.json');
            const data = await res.json();
            videos.value = data.videos;
          } catch (err) {
            console.error(err);
          }
        };

        // Предзагрузка следующих 2 видео
        const preloadNext = (index) => {
          for (let i = 1; i <= 2; i++) {
            const nextIndex = (index + i) % videos.value.length;
            if (nextIndex === index) break;
            const video = document.querySelector(`#video-${nextIndex}`);
            if (video) {
              video.preload = 'auto';
              video.load();
            }
          }
        };

        onMounted(async () => {
          await loadVideos();
          await nextTick();

          const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              const video = entry.target.querySelector('video');
              const index = parseInt(entry.target.dataset.index);

              if (entry.isIntersecting && entry.intersectionRatio >= 0.7) {
                video.play();
                currentIndex.value = index;
                preloadNext(index); // Предзагрузка следующих

                // Показываем оверлей и музыку
                entry.target.querySelector('.info').classList.add('visible');
                entry.target.querySelector('.music').classList.add('visible');
              } else {
                video.pause();
                entry.target.querySelector('.info').classList.remove('visible');
                entry.target.querySelector('.music').classList.remove('visible');
              }
            });
          }, { threshold: [0, 0.7, 1] });

          document.querySelectorAll('.video-container').forEach(el => {
            observer.observe(el);
          });

          // Предзагрузка первого видео сразу
          preloadNext(-1);
        });

        // Двойной тап и одиночный тап
        const handleTap = (index, e) => {
          if (e.target.closest('.sidebar')) return;

          const video = document.getElementById(`video-${index}`);
          const container = e.currentTarget;

          // Одиночный тап — пауза/плей
          if (video.paused) {
            video.paused ? video.play() : video.pause();
            return;
          }

          // Двойной тап — лайк
          const likeAnim = container.querySelector('.like-animation');
          likeAnim.classList.add('show');
          setTimeout(() => likeAnim.classList.remove('show'), 800);

          // Пульсация сердца на боковой панели
          const likeBtn = container.querySelector('.like-btn');
          likeBtn.classList.add('liked');
          setTimeout(() => likeBtn.classList.remove('liked'), 600);

          // Увеличиваем счётчик
          const countEl = likeBtn.querySelector('.count');
          let count = parseInt(countEl.textContent.replace(/[^0-9]/g, '')) || 0;
          count++;
          countEl.textContent = count > 999 ? (count/1000).toFixed(1)+'K' : count;
        };

        let tapTimer = null;
        const handleTouch = (index, e) => {
          if (tapTimer) {
            clearTimeout(tapTimer);
            tapTimer = null;
            handleTap(index, e); // двойной
          } else {
            tapTimer = setTimeout(() => {
              const video = document.getElementById(`video-${index}`);
              video.paused ? video.play() : video.pause();
              tapTimer = null;
            }, 300);
          }
        };

        return { videos, handleTouch };
      },

      template: `
        <div id="app">
          <div v-for="(item, index) in videos" :key="index" class="video-container" :data-index="index" @click="handleTouch(index, $event)">
            <video :id="'video-' + index" :src="item.url" loop muted playsinline preload="metadata"></video>

            <div class="bottom-overlay"></div>

            <div class="info">
              <div class="author">
                <span>@{{ item.author }}</span>
              </div>
              <div class="description">{{ item.description }}</div>
            </div>

            <div class="music">
              <div class="music-disc"><i class="ri-music-2-fill"></i></div>
              <div>♪ {{ item.music }}</div>
            </div>

            <div class="sidebar">
              <div class="sidebar-item">
                <img :src="item.avatar" class="avatar">
                <div class="plus">+</div>
              </div>
              <div class="sidebar-item like-btn">
                <div class="icon">❤️</div>
                <div class="count">{{ item.likes }}</div>
              </div>
              <div class="sidebar-item">
                <div class="icon"><i class="ri-message-3-line"></i></div>
                <div class="count">{{ item.comments }}</div>
              </div>
              <div class="sidebar-item">
                <div class="icon"><i class="ri-share-forward-line"></i></div>
                <div class="count">Поделиться</div>
              </div>
            </div>

            <div class="like-animation">❤️</div>
          </div>
        </div>
      `
    }).mount('#app');
  </script>
</body>
</html>